<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<script type="text/javascript" src="https://www.google.com/jsapi?key=INSERT-YOUR-KEY"></script>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>workshop</title>

	<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.3.2.min.js" type="text/javascript"></script>  
    <script language="Javascript" type="text/javascript">
    var state = {
      canal: "Canal Web",
      me: ""
    };
    
    function MobiApp_Init(jsonStr) {
    	var deviceState = eval('(' + jsonStr + ')');
    	state.canal = deviceState.channel.name;
    }
    
    $(document).ready(function() {
    	bindLoginFunctions( );
    	bindChatFunctions( );
    	
    	showOnlyThisDiv("logon");

	});
    
    function bindLoginFunctions() {
    	$("#btnEntrar").click(function() {
    		doLogin(this);
    	});
    }
    
    function bindChatFunctions() {
    	$("#btnSendMessage").click(function() { 
			doSendMessage();
    	});
		
		$("#txtMessage").keypress(function(e) { 
			if(e.which == 13){
				doSendMessage();
				e.preventDefault();
				return false;
			}
		});
    }
    
    function doLogin(owner) {
    	$(owner).attr("disabled",true);
    	showOnlyThisDiv("loggingIn");
    	
    	state.me = $("#txtNickname").val();
    	
    	$.post('workshop/doLogin',{nickname: state.me }, function(data){
	        
    		// fazer o que?
    		//$('#txtPergunta').val("");
	        //$('#retorno').text(data);
	        $(owner).removeAttr("disabled");
	        showOnlyThisDiv("chat");
	        $("#txtMessage").focus();
		});
    }
    
    function doSendMessage() {
    	if($("#btnSendMessage").is(":enabled")) {
    		$("#btnSendMessage").attr("disabled", true);
    		
    		var sMessage =  $("#txtMessage").val();
    		$('#workshopResponseArea').html("");
    		
    		$.post('workshop/sendMessage',{nickname: state.me, canal: state.canal, message: sMessage }, function(data){
    	        
        		$("#txtMessage").val("");
        		$('#workshopResponseArea').html(data);
    	        $("#btnSendMessage").removeAttr("disabled");
    		});
    	}
    }
    
    
    function showOnlyThisDiv(divName) {
    	var objName = "#" + divName;
		var mainDivs = [ "logon", "loggingIn", "chat" ];
		
		for (var idx = 0; idx < mainDivs.length; idx++) {
			if(mainDivs[idx] != divName) {
				var toHide = "#" + mainDivs[idx];
				if($(toHide).is(":visible"))
					$(toHide).hide("slow");
			}
		}
		$(objName).show("slow");
    }
	</script>
</head>
<body>

<div id="logon">
	<span><font color="blue">Nome: </font></span>
	<input type="text" size="10" name="nickname" id="txtNickname" value="Anônimo"/>
	<input type="button" id="btnEntrar" value="Entrar" />
</div>

<div id="loggingIn">
	<span><font color="blue">Carregando, aguarde...</font></span>
</div>

<div id="chat">
	<span><font color="blue">Pergunta: </font></span>
	<input type="text" id="txtMessage" size="25" value="" />
	<input type="button" id="btnSendMessage" value="Enviar" /><br/>
	<span id="workshopResponseArea"></span>
</div>

</body>
</html>