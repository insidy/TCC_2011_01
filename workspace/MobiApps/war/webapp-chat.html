<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<script type="text/javascript" src="https://www.google.com/jsapi?key=INSERT-YOUR-KEY"></script>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>chat</title>

	<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.3.2.min.js" type="text/javascript"></script>  
    <script language="Javascript" type="text/javascript">
    var state = {
      sala: "",
      me: "",
      lastTick: ""
    };
    
    var device = {
      canal: ""
    };
    
    function MobiApp_Init(jsonStr) {
    	var deviceState = eval('(' + jsonStr + ')');
    	device.canal = deviceState.channel.name;
    	
    	$("#txtSala").val(device.canal);
    }
    
    function MobiApp_Finish(jsonStr) {
    	if(state.me != "") {
    		doExit($("#btnExitChat"));
    	}
    }
    
    $(document).ready(function() {
    	
    	bindLoginFunctions( );
    	bindChatFunctions( );
    	
    	showOnlyThisDiv("logon");

	});
    
    function bindLoginFunctions() {
    	$("#btnEntrar").click(function() {
    		doLogin(this);
    	});
    }
    
    function bindChatFunctions() {
    	$("#btnExitChat").click(function() { 
    		doExit(this);
    	});
    	
		$("#btnSendMessage").click(function() { 
			doSendMessage();
    	});
		
		$("#txtMessage").keypress(function(e) { 
			if(e.which == 13){
				doSendMessage();
				e.preventDefault();
				return false;
			}
		});
    }
    
    function doLogin(owner) {
    	$(owner).attr("disabled",true);
    	showOnlyThisDiv("loggingIn");
    	
    	state.sala = $("#txtSala").val();
    	state.me = $("#txtNickname").val();
    	state.lastTick = (new Date()).getTime() - 100;
    	
    	$.post('chat/doLogin',{sala: state.sala, nickname: state.me }, function(data){
	        
    		// fazer o que?
    		//$('#txtPergunta').val("");
	        //$('#retorno').text(data);
	        $(owner).removeAttr("disabled");
	        showOnlyThisDiv("chat");
	        getMessages( );
	        setTimeout("checkGetMessages()", 20000);
	        $("#txtMessage").focus();
		});
    }
    
    function doExit(owner) {
    	$(owner).attr("disabled",true);
    	showOnlyThisDiv("loggingOut");
    	
		$.post('chat/doLogout',{sala: state.sala, nickname: state.me }, function(data){
	        state.sala = "";
	        state.me = "";
	        
	        
    		// fazer o que?
    		//$('#txtPergunta').val("");
	        //$('#retorno').text(data);
	        $(owner).removeAttr("disabled");
	        showOnlyThisDiv("logon");
		});
    }
	
    function doSendMessage() {
    	if($("#btnSendMessage").is(":enabled")) {
    		$("#btnSendMessage").attr("disabled", true);
    		
    		var sMessage =  $("#txtMessage").val();
    		
    		$.post('chat/sendMessage',{sala: state.sala, nickname: state.me, message: sMessage }, function(data){
    	        
        		$("#txtMessage").val("");
        		var currentContent = $('#chatArea').html();
        		$('#chatArea').html(currentContent + data);
        		$("#chatArea").scrollTop($("#chatArea")[0].scrollHeight);
    	        
    	        $("#btnSendMessage").removeAttr("disabled");
    		});
    	}
    }
    
    function getMessages() {
    	if(state.sala != "") { 
	    	$.post('/chat/getMessages',{sala: state.sala, nickname: state.me, tick: state.lastTick }, function(data){
	    		var currentContent = $('#chatArea').html();
	    		$('#chatArea').html(currentContent + data);
	    		$("#chatArea").scrollTop($("#chatArea")[0].scrollHeight);
	    		
	    		setTimeout("getMessages()", 2000);		
	    	});
	    	state.lastTick = (new Date()).getTime() - 100;
    	}
    }
    
    function checkGetMessages() {
    	if(state.sala != "") {
	    	setTimeout("checkGetMessages()", 10000);
	    	var tickNow = (new Date()).getTime();
	    	
	    	if(state.lastTick < (tickNow - 1000)) {
	    		getMessages();
	    	}
    	}
    	
    }
    
    function showOnlyThisDiv(divName) {
    	var objName = "#" + divName;
		var mainDivs = [ "logon", "loggingIn", "loggingOut", "chat" ];
		
		for (var idx = 0; idx < mainDivs.length; idx++) {
			if(mainDivs[idx] != divName) {
				var toHide = "#" + mainDivs[idx];
				if($(toHide).is(":visible"))
					$(toHide).hide("slow");
			}
		}
		$(objName).show("slow");
    }
	</script>
</head>
<body>

<div id="logon">
	<input type="text" size="10" name="sala" id="txtSala" value="Default"/>
	<input type="text" size="10" name="nickname" id="txtNickname" value="Anônimo"/>
	<input type="button" id="btnEntrar" value="Entrar" />
</div>

<div id="loggingIn">
	<span>Carregando, aguarde...</span>
</div>

<div id="loggingOut">
	<span>Saindo do chat, aguarde...</span>
</div>

<div id="chat">
	<div id="chatArea" style="width:75%; height:100px; border: 1px solid black; overflow:auto;"> </div>
	<input type="text" id="txtMessage" size="25" value="" />
	<input type="button" id="btnSendMessage" value="Enviar" />
	<input type="button" id="btnExitChat" value="Sair" />	
</div>

</body>
</html>